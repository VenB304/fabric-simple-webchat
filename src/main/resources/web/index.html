<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Web Chat</title>
    <style>
        * {
            box-sizing: border-box;
        }

        /* Crucial for consistent sizing */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #121212;
            color: #e0e0e0;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        /* Login Screen */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #0f0f0f;
            z-index: 200;
            position: absolute;
            width: 100%;
            top: 0;
            left: 0;
        }

        #login-box {
            background: #1e1e1e;
            padding: 40px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            width: 80%;
            max-width: 300px;
        }

        #login-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #4fc3f7;
        }

        #username-input {
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 20px;
            font-size: 16px;
            padding: 12px;
        }

        /* Main UI */
        #header-bar {
            display: none;
            background: #181818;
            padding: 10px;
            border-bottom: 1px solid #333;
            justify-content: space-between;
            align-items: center;
            height: 50px;
            flex-shrink: 0;
        }

        #header-title {
            font-weight: bold;
            color: #4fc3f7;
        }

        #menu-btn {
            background: transparent;
            border: 1px solid #333;
            color: #ccc;
            font-size: 20px;
            padding: 5px 10px;
            cursor: pointer;
        }

        #main-ui {
            display: none;
            flex-direction: row;
            flex: 1;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        #chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-width: 0;
            /* Prevents flex item from expanding beyond container */
            position: relative;
        }

        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: #121212;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        /* Sidebar (User List) */
        #sidebar {
            width: 220px;
            background: #181818;
            border-left: 1px solid #333;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            font-weight: bold;
            color: #888;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            margin-top: 10px;
        }

        .sidebar-header:first-child {
            margin-top: 0;
        }

        .user-item {
            padding: 6px 0;
            font-size: 14px;
            border-bottom: 1px solid #222;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            #header-bar {
                display: flex;
            }

            #sidebar {
                position: absolute;
                right: 0;
                top: 0;
                height: 100%;
                z-index: 100;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                box-shadow: -2px 0 5px rgba(0, 0, 0, 0.5);
                border-left: none;
            }

            #sidebar.open {
                transform: translateX(0);
            }

            #overlay {
                display: none;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 90;
            }

            #overlay.open {
                display: block;
            }
        }

        .message {
            background: #1e1e1e;
            padding: 8px 12px;
            border-radius: 4px;
            animation: fadeIn 0.2s;
            word-wrap: break-word;
            /* Legacy */
            overflow-wrap: break-word;
            /* Standard */
            word-break: break-word;
            /* Robustness */
            max-width: 100%;
        }

        .message .user {
            font-weight: bold;
            color: #4fc3f7;
            margin-right: 8px;
        }

        .message .text {
            color: #ffffff;
            line-height: 1.4;
        }

        #input-area {
            padding: 15px;
            background: #1e1e1e;
            display: flex;
            gap: 10px;
            border-top: 1px solid #333;
            align-items: center;
            flex-shrink: 0;
            /* Never shrink input area */
            width: 100%;
        }

        input {
            background: #2d2d2d;
            border: 1px solid #444;
            color: white;
            padding: 12px;
            border-radius: 4px;
            font-size: 16px;
            flex: 1;
            min-width: 0;
        }

        button#send-btn {
            background: #388e3c;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
        }

        button:hover {
            background: #2e7d32;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <div id="login-box">
            <div id="login-title">Join Server Chat</div>
            <input type="text" id="username-input" placeholder="Enter Username" maxlength="16">
            <button onclick="startChat()"
                style="width:100%; padding: 12px; background: #0288d1; border:none; color:white; font-size:16px; font-weight:bold; border-radius:4px; cursor:pointer;">Connect</button>
        </div>
    </div>

    <!-- Main UI -->
    <div id="header-bar">
        <div id="header-title">Web Chat</div>
        <button id="menu-btn" onclick="toggleSidebar()">â˜°</button>
    </div>

    <div id="main-ui">
        <div id="overlay" onclick="toggleSidebar()"></div>
        <div id="chat-area">
            <div id="chat-container"></div>
            <div id="input-area">
                <input type="text" id="message" placeholder="Type a message..." maxlength="256">
                <button id="send-btn" onclick="sendMessage()">Send</button>
            </div>
        </div>
        <div id="sidebar">
            <div class="sidebar-header">Online Players</div>
            <div id="player-list"></div>
            <div class="sidebar-header">Web Users</div>
            <div id="web-user-list"></div>
        </div>
    </div>

    <script>
        const loginScreen = document.getElementById('login-screen');
        const mainUi = document.getElementById('main-ui');
        const usernameInput = document.getElementById('username-input');
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message');
        const playerListDiv = document.getElementById('player-list');
        const webUserListDiv = document.getElementById('web-user-list');

        let ws;
        let reconnectInterval = 1000;
        let heartbeatInterval;
        let myUsername = "";

        // Restore username
        if (localStorage.getItem('chat_username')) {
            usernameInput.value = localStorage.getItem('chat_username');
        }

        const headerBar = document.getElementById('header-bar');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        function toggleSidebar() {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
        }

        function startChat() {
            const name = usernameInput.value.trim();
            if (!name) return alert("Please enter a username needed.");

            myUsername = name;
            localStorage.setItem('chat_username', myUsername);

            loginScreen.style.display = 'none';
            mainUi.style.display = 'flex';

            // Check if mobile to show header
            if (window.innerWidth <= 768) {
                headerBar.style.display = 'flex';
            }

            connect();
        }

        // Listen for resize to fix header visibility just in case
        window.addEventListener('resize', () => {
            if (mainUi.style.display === 'flex') {
                headerBar.style.display = (window.innerWidth <= 768) ? 'flex' : 'none';
            }
        });

        function connect() {
            const proto = window.location.protocol === 'https:' ? 'wss' : 'ws';
            ws = new WebSocket(`${proto}://${window.location.host}/chat?username=${encodeURIComponent(myUsername)}`);

            ws.onopen = () => {
                addConnectionDivider("Connected to server");
                reconnectInterval = 1000;

                // Heartbeat
                if (heartbeatInterval) clearInterval(heartbeatInterval);
                heartbeatInterval = setInterval(() => { if (ws.readyState === 1) ws.send("PING"); }, 20000);
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);

                    if (data.type === 'message') {
                        addMessage(data.user, data.message);
                    } else if (data.type === 'playerList') {
                        updateLists(data.players, data.webUsers);
                    }
                } catch (e) {
                    // console.error(e);
                }
            };

            ws.onclose = () => {
                addConnectionDivider("Disconnected from server");
                if (heartbeatInterval) clearInterval(heartbeatInterval);
                setTimeout(connect, reconnectInterval);
                reconnectInterval = Math.min(reconnectInterval * 2, 30000);
            };
        }

        function updateLists(players, webUsers) {
            playerListDiv.innerHTML = players.map(p => `<div class="user-item" style="color:${getUsernameColor(p)}">${escapeHtml(p)}</div>`).join('');
            webUserListDiv.innerHTML = webUsers.map(u => `<div class="user-item" style="color:${getUsernameColor(u)}">${escapeHtml(u)}</div>`).join('');
        }

        function sendMessage() {
            const msg = messageInput.value.trim();
            if (!msg) return;
            if (ws && ws.readyState === WebSocket.OPEN) {
                // Now sending generic text, username is bound to session
                ws.send(msg);
                messageInput.value = '';
            }
        }

        function addMessage(user, text) {
            const div = document.createElement('div');
            div.className = 'message';
            const color = getUsernameColor(user);
            div.innerHTML = `<span class="user" style="color: ${color}">${escapeHtml(user)}</span><span class="text">${escapeHtml(text)}</span>`;
            chatContainer.appendChild(div);
            // Auto-scroll
            if (chatContainer.scrollHeight - chatContainer.scrollTop < 1000)
                chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.className = 'message';
            div.style.color = '#888';
            div.style.fontStyle = 'italic';
            div.innerText = "[System] " + text;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addConnectionDivider(text) {
            const div = document.createElement('div');
            div.style.cssText = "display: flex; align-items: center; justify-content: center; margin: 10px 0; color: #555; font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;";

            const line = "flex: 1; height: 1px; background: #333; margin: 0 10px;";
            div.innerHTML = `<div style="${line}"></div><span>${escapeHtml(text)}</span><div style="${line}"></div>`;

            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        const COLORS = ["#e60000", "#0000e6", "#00b300", "#e6e600", "#e68a00", "#bf00bf", "#00bfbf", "#e66699", "#99e699", "#804d00"];
        function getUsernameColor(username) {
            let hash = 0;
            for (let i = 0; i < username.length; i++) hash = username.charCodeAt(i) + ((hash << 5) - hash);
            return COLORS[Math.abs(hash % COLORS.length)];
        }
        function escapeHtml(text) { return text.replace(/[&<>"']/g, function (m) { return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '\"': '&quot;', '\'': '&#039;' }[m]; }); }

        messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
        usernameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') startChat(); });
    </script>
</body>

</html>