<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple WebChat</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #121212;
            color: #e0e0e0;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        /* Login Screen */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #0f0f0f;
            z-index: 200;
            position: absolute;
            width: 100%;
            top: 0;
            left: 0;
        }

        #login-box {
            background: #1e1e1e;
            padding: 40px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            width: 80%;
            max-width: 320px;
        }

        #login-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #4fc3f7;
        }

        .input-group {
            margin-bottom: 15px;
            width: 100%;
        }

        input {
            width: 100%;
            padding: 12px;
            background: #2d2d2d;
            border: 1px solid #444;
            color: white;
            border-radius: 4px;
            font-size: 16px;
        }

        button.btn-primary {
            width: 100%;
            padding: 12px;
            background: #0288d1;
            border: none;
            color: white;
            font-size: 16px;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        button.btn-primary:hover {
            background: #0277bd;
        }

        button.btn-secondary {
            background: #444;
            margin-top: 10px;
        }

        button.btn-success {
            background: #388e3c;
        }

        button.btn-warning {
            background: #f57f17;
        }

        .error-msg {
            color: #ff5252;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }

        /* Main UI */
        #header-bar {
            display: none;
            background: #181818;
            padding: 10px;
            border-bottom: 1px solid #333;
            justify-content: space-between;
            align-items: center;
            height: 50px;
            flex-shrink: 0;
        }

        #header-title {
            font-weight: bold;
            color: #4fc3f7;
        }

        #menu-btn {
            background: transparent;
            border: 1px solid #333;
            color: #ccc;
            font-size: 20px;
            padding: 5px 10px;
            cursor: pointer;
        }

        #logout-btn {
            background: #c62828;
            border: none;
            color: white;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
        }

        #main-ui {
            display: none;
            flex-direction: row;
            flex: 1;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        #chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-width: 0;
            position: relative;
        }

        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: #121212;
            scroll-behavior: smooth;
        }

        #sidebar {
            width: 220px;
            background: #181818;
            border-left: 1px solid #333;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            font-weight: bold;
            color: #888;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            margin-top: 10px;
        }

        .user-item {
            padding: 6px 0;
            font-size: 14px;
            border-bottom: 1px solid #222;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            #header-bar {
                display: flex;
            }

            #sidebar {
                position: absolute;
                right: 0;
                top: 0;
                height: 100%;
                z-index: 100;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                box-shadow: -2px 0 5px rgba(0, 0, 0, 0.5);
                border-left: none;
            }

            #sidebar.open {
                transform: translateX(0);
            }

            #overlay {
                display: none;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 90;
            }

            #overlay.open {
                display: block;
            }
        }

        .message {
            background: #1e1e1e;
            padding: 8px 12px;
            border-radius: 4px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 100%;
        }

        .message .user {
            font-weight: bold;
            margin-right: 8px;
        }

        .message .text {
            color: #ffffff;
            line-height: 1.4;
        }

        #input-area {
            padding: 15px;
            background: #1e1e1e;
            display: flex;
            gap: 10px;
            border-top: 1px solid #333;
            align-items: center;
            flex-shrink: 0;
            width: 100%;
        }

        #input-area input {
            flex: 1;
        }
    </style>
</head>

<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <div id="login-box">
            <div id="login-title">Simple WebChat</div>

            <div id="auth-loading" style="color: #888;">Connecting...</div>
            <div id="reconnect-msg" style="color: #ff5252; display:none; margin-bottom:10px; font-size:14px;">
                Reconnecting...</div>

            <!-- NONE Mode -->
            <div id="login-none" style="display:none;">
                <div class="input-group">
                    <input type="text" id="none-username" placeholder="Desired Username" maxlength="16">
                </div>
                <button class="btn-primary" onclick="loginNone()">Join Chat</button>
            </div>

            <!-- SIMPLE Mode -->
            <div id="login-simple" style="display:none;">
                <div class="input-group">
                    <input type="text" id="simple-username" placeholder="Username" maxlength="16">
                </div>
                <div class="input-group">
                    <input type="password" id="simple-password" placeholder="Server Password">
                </div>
                <button class="btn-primary" onclick="loginSimple()">Login</button>
            </div>

            <!-- LINKED Mode -->
            <div id="login-linked" style="display:none;">

                <!-- Initial State: Get Code -->
                <div id="linked-step-1">
                    <div style="margin-bottom: 10px; font-size: 14px; color: #ccc;">
                        Enter your Minecraft username and click "Get Code" to receive a login code in-game.
                    </div>
                    <div class="input-group">
                        <input type="text" id="linked-username" placeholder="Minecraft Username" maxlength="16">
                    </div>
                    <button class="btn-primary btn-warning" onclick="requestOtp()">Get Code</button>

                    <div id="resume-session-container"
                        style="display:none; margin-top: 15px; border-top: 1px solid #333; padding-top: 15px;">
                        <div style="margin-bottom:10px; color:#888;">Session found for: <b id="resume-username"
                                style="color:white;"></b></div>
                        <button class="btn-primary btn-success" onclick="resumeSession()">Enter Chat</button>
                        <button class="btn-primary btn-secondary" onclick="logoutLinked()">Sign Out</button>
                    </div>
                </div>

                <!-- Step 2: Verify Code -->
                <div id="linked-step-2" style="display:none;">
                    <div style="margin-bottom: 10px; font-size: 14px; color: #ccc;">
                        Code sent! Check your in-game chat.
                    </div>
                    <div class="input-group">
                        <input type="text" id="linked-code" placeholder="123456" maxlength="6">
                    </div>
                    <button class="btn-primary btn-success" onclick="verifyOtp()">Verify & Login</button>
                    <button class="btn-primary btn-secondary" onclick="resetLinkedUi()">Back</button>
                </div>

            </div>

            <div id="error-msg" class="error-msg"></div>
        </div>
    </div>

    <!-- Main UI -->
    <div id="header-bar">
        <div id="header-title">Web Chat</div>
        <div style="display:flex; align-items:center;">
            <button id="logout-btn" onclick="logout()">Logout</button>
            <button id="menu-btn" onclick="toggleSidebar()" style="margin-left:10px;">â˜°</button>
        </div>
    </div>

    <div id="main-ui">
        <div id="overlay" onclick="toggleSidebar()"></div>
        <div id="chat-area">
            <div id="chat-container"></div>
            <div id="input-area">
                <input type="text" id="message" placeholder="Type a message..." maxlength="256">
                <button id="send-btn" class="btn-primary btn-success" style="width:auto; padding: 12px 20px;"
                    onclick="sendMessage()">Send</button>
            </div>
        </div>
        <div id="sidebar">
            <div
                style="padding-bottom:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:bold; font-size:12px; color:#666;">LOGGED IN AS</span>
                <span id="current-user-display" style="font-weight:bold; color:white;"></span>
                <span id="logout-sidebar"
                    style="cursor:pointer; color:#c62828; font-size:10px; text-decoration:underline;"
                    onclick="logout()">LOGOUT</span>
            </div>
            <div class="sidebar-header">Online Players</div>
            <div id="player-list"></div>
            <div class="sidebar-header">Web Users</div>
            <div id="web-user-list"></div>
        </div>
    </div>

    <script>
        const views = {
            loading: document.getElementById('auth-loading'),
            reconnect: document.getElementById('reconnect-msg'),
            none: document.getElementById('login-none'),
            simple: document.getElementById('login-simple'),
            linked: document.getElementById('login-linked'),
            screen: document.getElementById('login-screen'),
            main: document.getElementById('main-ui')
        };

        // State
        let ws;
        let pinger;
        let myUsername = "";
        let currentAuthMode = null;
        let isReconnecting = false;
        let reconnectDelay = 2000;

        attemptConnect();

        function attemptConnect() {
            if (isReconnecting && currentAuthMode !== null) {
                // If we are strictly reconnecting (known mode), show small message
                views.reconnect.style.display = 'block';
            } else {
                // Initial load
                views.loading.style.display = 'block';
            }

            const savedUser = localStorage.getItem('swc_username') || "";
            const savedPass = localStorage.getItem('swc_password') || "";
            const savedToken = localStorage.getItem('swc_token') || "";

            const proto = window.location.protocol === 'https:' ? 'wss' : 'ws';
            let url = `${proto}://${window.location.host}/chat`;

            if (savedUser) {
                url += `?username=${encodeURIComponent(savedUser)}`;
                if (savedPass) url += `&password=${encodeURIComponent(savedPass)}`;
                if (savedToken) url += `&token=${encodeURIComponent(savedToken)}`;
            }
            // Do NOT append GuestProbe default. Let server handle empty username as unauthenticated/handshake.

            if (ws) {
                try { ws.close(); } catch (e) { }
            }

            ws = new WebSocket(url);

            ws.onopen = () => {
                isReconnecting = false;
                reconnectDelay = 2000;
                views.reconnect.style.display = 'none';
                views.loading.style.display = 'none'; // Only hide if we get status?
                // Actually wait for status to hide loading, but we can hide reconnect msg

                if (pinger) clearInterval(pinger);
                pinger = setInterval(() => { if (ws && ws.readyState === 1) ws.send("PING"); }, 20000);
            };

            ws.onmessage = (e) => {
                if (e.data === "PING") return;
                try {
                    const data = JSON.parse(e.data);

                    if (data.type === 'status') {
                        handleStatus(data);
                    } else if (data.type === 'message') {
                        addMessage(data.user, data.message);
                    } else if (data.type === 'playerList') {
                        updateLists(data.players, data.webUsers);
                    } else if (data.type === 'otp_sent') {
                        document.getElementById('linked-step-1').style.display = 'none';
                        document.getElementById('linked-step-2').style.display = 'block';
                    } else if (data.type === 'auth_success') {
                        localStorage.setItem('swc_token', data.token);
                        localStorage.setItem('swc_username', data.username);
                        location.reload();
                    } else if (data.type === 'error') {
                        showError(data.message);
                    }
                } catch (err) { }
            };

            ws.onclose = (e) => {
                // ALWAYS Retry unless user explicitly logged out (which reloads page anyway)
                // If 4003 (Auth Fail), we don't retry same creds maybe?
                // But if we are in LINKED mode handshake, we might get closed if token invalid?
                // No, we fixed AuthHandler to return HANDSHAKE_ONLY.

                isReconnecting = true;

                if (e.code === 4003 && currentAuthMode === 'SIMPLE') {
                    // Password wrong? show error
                    views.loading.style.display = 'none';
                    views.simple.style.display = 'block';
                    showError("Authentication Failed. Check password.");
                    return; // Don't loop retry if creds wrong
                }

                // Show reconnecting UI if in chat
                if (views.main.style.display === 'flex') {
                    addConnectionDivider("Disconnected. Reconnecting in " + (reconnectDelay / 1000) + "s...");
                } else if (currentAuthMode !== null) {
                    views.reconnect.style.display = 'block';
                } else {
                    views.loading.style.display = 'block';
                    views.loading.innerText = "Connection lost. Retrying...";
                }

                setTimeout(attemptConnect, reconnectDelay);
                reconnectDelay = Math.min(reconnectDelay * 1.5, 15000);
            };
        }

        function handleStatus(status) {
            currentAuthMode = status.authMode;
            views.loading.style.display = 'none';
            views.reconnect.style.display = 'none';

            if (status.authenticated) {
                myUsername = status.username;
                enterChat();
            } else {
                // Not authenticated
                // Update UI based on mode
                if (currentAuthMode === 'NONE') {
                    setupNone();
                } else if (currentAuthMode === 'SIMPLE') {
                    setupSimple();
                } else if (currentAuthMode === 'LINKED') {
                    setupLinked(status.username);
                }
            }
        }

        function enterChat() {
            views.screen.style.display = 'none';
            views.main.style.display = 'flex';
            document.getElementById('current-user-display').innerText = myUsername;

            if (window.innerWidth <= 768) {
                document.getElementById('header-bar').style.display = 'flex';
            }
            addConnectionDivider("Connected to Server");

            // Scroll to bottom
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        }

        // -- UI Setups --
        function setupNone() {
            views.none.style.display = 'block';
            // Only auto-login if we haven't failed recently?
            // If we are here, we are NOT authenticated.
            const saved = localStorage.getItem('swc_username');
            if (saved) document.getElementById('none-username').value = saved;
        }
        function setupSimple() {
            views.simple.style.display = 'block';
            const user = localStorage.getItem('swc_username');
            if (user) document.getElementById('simple-username').value = user;
            // Don't autofill password for security/UX logic if it failed
        }
        function setupLinked(currentTempName) {
            views.linked.style.display = 'block';
            const token = localStorage.getItem('swc_token');
            const user = localStorage.getItem('swc_username');

            if (token && user) {
                document.getElementById('resume-session-container').style.display = 'block';
                document.getElementById('resume-username').innerText = user;
            }
            if (user && !document.getElementById('linked-username').value) {
                document.getElementById('linked-username').value = user;
            }
        }

        // -- Actions --
        function loginNone() {
            const user = document.getElementById('none-username').value.trim();
            if (!user) return showError("Username required");
            localStorage.setItem('swc_username', user);
            location.reload();
        }

        function loginSimple() {
            const user = document.getElementById('simple-username').value.trim();
            const pass = document.getElementById('simple-password').value.trim();
            if (!user || !pass) return showError("Required fields missing");
            localStorage.setItem('swc_username', user);
            localStorage.setItem('swc_password', pass);
            location.reload();
        }

        function requestOtp() {
            const user = document.getElementById('linked-username').value.trim();
            if (!user) return showError("Username required");

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showError("Connection not ready. Please wait...");
                // attemptConnect() should be retrying
                return;
            }

            try {
                ws.send(JSON.stringify({ type: 'request_otp', username: user }));
            } catch (e) {
                showError("Send failed: " + e.message);
            }
        }

        function verifyOtp() {
            const user = document.getElementById('linked-username').value.trim();
            const code = document.getElementById('linked-code').value.trim();
            if (!user || !code) return showError("Code required");

            if (!ws || ws.readyState !== WebSocket.OPEN) return showError("Not connected.");

            ws.send(JSON.stringify({ type: 'verify_otp', username: user, code: code }));
        }

        function resumeSession() {
            // If we are here, the token we sent was REJECTED (authenticated=false).
            showError("Session expired. Please sign out and get a new code.");
        }

        function logoutLinked() {
            localStorage.removeItem('swc_token');
            document.getElementById('resume-session-container').style.display = 'none';
            resetLinkedUi();
            // Maybe reload to probe as fresh guest?
            location.reload();
        }

        function resetLinkedUi() {
            document.getElementById('linked-step-2').style.display = 'none';
            document.getElementById('linked-step-1').style.display = 'block';
        }

        function logout() {
            localStorage.removeItem('swc_username');
            localStorage.removeItem('swc_password');
            localStorage.removeItem('swc_token');
            location.reload();
        }

        function showError(msg) {
            const el = document.getElementById('error-msg');
            el.innerText = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        // -- DOM Helpers --
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message');
        const playerListDiv = document.getElementById('player-list');
        const webUserListDiv = document.getElementById('web-user-list');
        const overlay = document.getElementById('overlay');
        const sidebar = document.getElementById('sidebar');

        function toggleSidebar() {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
        }

        function sendMessage() {
            const msg = messageInput.value.trim();
            if (!msg) return;
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(msg);
                messageInput.value = '';
            } else {
                addConnectionDivider("Cannot send: Disconnected");
            }
        }
        messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
        document.getElementById('none-username').addEventListener('keypress', e => e.key === 'Enter' && loginNone());
        document.getElementById('simple-password').addEventListener('keypress', e => e.key === 'Enter' && loginSimple());
        document.getElementById('linked-code').addEventListener('keypress', e => e.key === 'Enter' && verifyOtp());

        function addMessage(user, text) {
            const div = document.createElement('div');
            div.className = 'message';
            const color = getUsernameColor(user);
            div.innerHTML = `<span class="user" style="color: ${color}">${escapeHtml(user)}</span><span class="text">${escapeHtml(text)}</span>`;
            chatContainer.appendChild(div);
            if (chatContainer.scrollHeight - chatContainer.scrollTop < 1000)
                chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function updateLists(players, webUsers) {
            playerListDiv.innerHTML = players.map(p => `<div class="user-item" style="color:${getUsernameColor(p)}">${escapeHtml(p)}</div>`).join('');
            webUserListDiv.innerHTML = webUsers.map(u => `<div class="user-item" style="color:${getUsernameColor(u)}">${escapeHtml(u)}</div>`).join('');
        }

        function addConnectionDivider(text) {
            const div = document.createElement('div');
            div.style.cssText = "display: flex; align-items: center; justify-content: center; margin: 10px 0; color: #555; font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;";
            const line = "flex: 1; height: 1px; background: #333; margin: 0 10px;";
            div.innerHTML = `<div style="${line}"></div><span>${escapeHtml(text)}</span><div style="${line}"></div>`;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        const COLORS = ["#e60000", "#0000e6", "#00b300", "#e6e600", "#e68a00", "#bf00bf", "#00bfbf", "#e66699", "#99e699", "#804d00"];
        function getUsernameColor(username) {
            let hash = 0;
            for (let i = 0; i < username.length; i++) hash = username.charCodeAt(i) + ((hash << 5) - hash);
            return COLORS[Math.abs(hash % COLORS.length)];
        }
        function escapeHtml(text) { if (!text) return ''; return text.replace(/[&<>"']/g, function (m) { return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '\"': '&quot;', '\'': '&#039;' }[m]; }); }

    </script>
</body>

</html>